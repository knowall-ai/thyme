= Thyme Deployment Guide
:toc:

== Prerequisites

* Azure subscription with App Service plan
* Microsoft Entra ID tenant (Azure AD)
* Business Central environment with API access
* Node.js 20 LTS (for local development)

== Azure Resource Setup

=== 1. Create App Service

[source,bash]
----
# Create resource group
az group create --name thyme-rg --location westeurope

# Create App Service plan (Linux, B1)
az appservice plan create \
  --name thyme-plan \
  --resource-group thyme-rg \
  --sku B1 \
  --is-linux

# Create web app
az webapp create \
  --name thyme-knowall \
  --resource-group thyme-rg \
  --plan thyme-plan \
  --runtime "NODE:20-lts"
----

=== 2. Configure Custom Domain

[source,bash]
----
# Add custom domain
az webapp config hostname add \
  --webapp-name thyme-knowall \
  --resource-group thyme-rg \
  --hostname thyme.knowall.ai

# Enable HTTPS (after DNS verification)
az webapp config ssl bind \
  --name thyme-knowall \
  --resource-group thyme-rg \
  --certificate-thumbprint <cert-thumbprint> \
  --ssl-type SNI
----

== Entra ID App Registration

=== 1. Create App Registration

1. Go to Azure Portal → Microsoft Entra ID → App registrations
2. Click "New registration"
3. Configure:
   - Name: `Thyme - Time Tracking`
   - Supported account types: `Single tenant`
   - Redirect URI: `https://thyme.knowall.ai` (SPA)

=== 2. Configure Authentication

1. Go to Authentication tab
2. Add platform: Single-page application
3. Add redirect URIs:
   - `https://thyme.knowall.ai`
   - `http://localhost:3000` (for development)
4. Enable "Access tokens" and "ID tokens"

=== 3. Configure API Permissions

1. Go to API permissions tab
2. Add permissions:
   - Microsoft Graph: `User.Read`
   - Dynamics 365 Business Central: `.default`
3. Grant admin consent

=== 4. Create Client Secret (if needed for backend)

1. Go to Certificates & secrets
2. Create new client secret
3. Save the value securely

== Environment Variables

Set these in Azure App Service Configuration:

[source]
----
NEXT_PUBLIC_AZURE_CLIENT_ID=<app-registration-client-id>
NEXT_PUBLIC_AZURE_TENANT_ID=<tenant-id>
NEXT_PUBLIC_AZURE_REDIRECT_URI=https://thyme.knowall.ai
BC_ENVIRONMENT=production
BC_COMPANY_ID=<business-central-company-guid>
NEXT_PUBLIC_BC_BASE_URL=https://api.businesscentral.dynamics.com/v2.0
----

== CI/CD Pipeline (GitHub Actions)

Create `.github/workflows/deploy.yml`:

[source,yaml]
----
name: Deploy to Azure

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Build
      run: npm run build
      env:
        NEXT_PUBLIC_AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        NEXT_PUBLIC_AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

    - name: Deploy to Azure
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'thyme-knowall'
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
        package: .next/standalone
----

== PR Testing with Deployment Slots

=== Overview

The repository includes a manual workflow that allows reviewers to deploy PRs to Azure App Service deployment slots for testing before merging. This enables testing in a production-like environment without affecting the main application.

=== Prerequisites

1. **Azure App Service Plan**: Standard tier or higher (required for deployment slots)
2. **Deployment Slot**: Create a staging slot for PR testing

==== Create Deployment Slots

Thyme uses 4 deployment slots (slot1-slot4) for PR testing:

[source,bash]
----
# Create 4 deployment slots
for i in {1..4}; do
  az webapp deployment slot create \
    --name thyme-knowall \
    --resource-group KnowAllAIRG \
    --slot "slot${i}"
done

# Environment variables are configured automatically per slot
# Each slot has its own redirect URI pointing to slotN.knowall.ai
----

=== GitHub Secrets Setup

Configure these secrets in your GitHub repository (Settings → Secrets and variables → Actions):

1. **AZURE_WEBAPP_NAME**: Your Azure App Service name (e.g., `thyme-knowall`)
2. **AZURE_WEBAPP_PUBLISH_PROFILE**: Download from Azure Portal → App Service → Deployment Center → Manage publish profile

To get the publish profile:

[source,bash]
----
# Download publish profile for the staging slot
az webapp deployment list-publishing-profiles \
  --name thyme-knowall \
  --resource-group thyme-rg \
  --slot staging \
  --xml
----

Copy the XML output and add it as the `AZURE_WEBAPP_PUBLISH_PROFILE` secret in GitHub.

=== Using the Workflow

1. **Navigate to Actions**: Go to your GitHub repository → Actions tab
2. **Select Workflow**: Click "Deploy PR to Azure Slot" from the workflow list
3. **Run Workflow**: Click "Run workflow" button
4. **Enter Details**:
   - **PR number**: The pull request number to deploy
   - **Slot name**: Target deployment slot (default: `slot1`, options: slot1-slot4)
5. **Monitor**: Watch the workflow execution in the Actions tab

The workflow will:

- ✅ Check for existing deployments in the target slot
- ✅ Validate the PR is open
- ✅ Run tests and type checking
- ✅ Build the application
- ✅ Create a GitHub deployment for tracking
- ✅ Deploy to the specified slot
- ✅ Update deployment status (active/inactive)
- ✅ Comment on both the current and previously deployed PRs
- ✅ Post deployment URL with custom domain

=== Deployment Tracking

The workflow uses **GitHub's Deployments API** to track which PR is deployed to each slot:

**View Deployments:**
- Go to your repository → Deployments tab
- See active and inactive deployments per slot
- Track deployment history for each PR

**PR Comments:**
- Each deployment posts a comment with the deployment URL
- If a slot is overwritten, both PRs receive notification comments
- Previous PR gets a "Deployment Replaced" comment
- New PR shows which deployment it replaced (if any)

**Deployment Status:**
- Active: Currently deployed and accessible
- Inactive: Overwritten by a newer deployment
- Failed: Deployment encountered errors

=== Testing the Deployment

After deployment completes:

1. Visit the deployment URL (e.g., `https://slot1.knowall.ai`)
2. Check the PR comment for the exact slot URL
3. Test the PR changes thoroughly:
   - Authentication flow (redirect URI is configured for the slot domain)
   - Business Central integration
   - New features or bug fixes
   - Mobile responsiveness
   - Cross-browser compatibility
4. Check the GitHub Deployments tab to see deployment status
5. If issues are found:
   - Request changes on the PR
   - Developer pushes fixes
   - Re-run the workflow to deploy updated code to the same slot

**Available Deployment Slots:**
- `slot1.knowall.ai` - Primary testing slot
- `slot2.knowall.ai` - Secondary testing slot
- `slot3.knowall.ai` - Additional slot for parallel testing
- `slot4.knowall.ai` - Additional slot for parallel testing

**Parallel Testing:**
Multiple PRs can be deployed to different slots simultaneously, allowing reviewers to test several changes in parallel without conflicts.

=== Cleanup

Deployment slots persist until manually deleted. To clean up after testing:

[source,bash]
----
# Delete a deployment slot (optional)
az webapp deployment slot delete \
  --name thyme-knowall \
  --resource-group thyme-rg \
  --slot staging
----

NOTE: You typically keep the staging slot and reuse it for multiple PR deployments.

== Manual Deployment

[source,bash]
----
# Build for production
npm run build

# The standalone output is in .next/standalone
# Deploy this folder to Azure App Service

# Or use Azure CLI
az webapp deployment source config-zip \
  --name thyme-knowall \
  --resource-group thyme-rg \
  --src deploy.zip
----

== Post-Deployment Checklist

- [ ] Verify app loads at https://thyme.knowall.ai
- [ ] Test Microsoft sign-in flow
- [ ] Verify Business Central API connection
- [ ] Check projects load from BC
- [ ] Test time entry creation
- [ ] Verify timer functionality
- [ ] Test on mobile devices
